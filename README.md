# TCP Клиент-Серверное Приложение для Linux и Windows

## Описание проекта

Целью данной работы является разработка и реализация клиент-серверного приложения для обмена сообщениями по протоколу TCP/IP с использованием асинхронной обработки событий.

В системе хранится текстовый файл, в котором записаны сообщения, по одному на строку. Сообщения состоят из нескольких частей, разделённых пробелом. Пустые строки в файле игнорируются. Формат сообщений зависит от варианта задания.

---

## Клиентская программа (tcpclient.cpp)

### Описание

Программа `tcpclient` представляет собой клиент, реализованный на языке C для POSIX-систем (Linux), предназначенный для отправки сообщений на TCP-сервер. Клиент читает данные из файла, парсит их в заданный формат, отправляет серверу и ожидает подтверждений. Код работает в блокирующем режиме с тайм-аутами на операции сокета, поддерживает несколько попыток подключения и обрабатывает ошибки на всех этапах.

### Формат входного файла

Строки входного файла имеют следующий формат:

```
dd.mm.yyyy AA +7xxxxxxxxxx Message
```

- `dd.mm.yyyy` — дата, например, `11.09.2001`.
- `AA` — целое знаковое число в диапазоне `-32768 <= AA <= 32767`.
- `+7xxxxxxxxxx` — номер телефона, длина 12 символов, где `x` — цифра от 0 до 9.
- `Message` — текст сообщения.

Части записи разделяются одним пробелом.

### Запуск клиента

Клиент запускается с аргументами командной строки:

```
tcpclient 192.168.50.7:9000 file1.txt
```

- `tcpclient` — имя исполняемого файла (получен компиляцией `tcpclient.cpp`).
- `192.168.50.7` — IPv4-адрес сервера.
- `9000` — TCP-порт сервера.
- `file1.txt` — файл с сообщениями.

### Особенности реализации клиента

- **Платформа**: Linux, компиляция с использованием `g++ 5.x`.
- **Режим работы сокета**: Блокирующий.
- **Обработка ошибок**:
  - При неудачном подключении клиент ждёт 100 мс и повторяет попытку (до 10 раз). После 10 неудач выводится ошибка в `stdout` и программа завершается.
  - Тайм-ауты на отправку и приём составляют 5 секунд.
  - Ошибки сокета обрабатываются с выводом кода ошибки через `handle_socket_error`.
- **Протокол взаимодействия**:
  - После подключения клиент отправляет 3 байта: коды символов `p`, `u`, `t` (команда `put`).
  - Каждое сообщение отправляется в следующем формате:
    - 4 байта — номер сообщения (32-битное целое, сетевой порядок байтов, индексация от 0).
    - 1 байт — день (1–31).
    - 1 байт — месяц (1–12).
    - 2 байта — год (0–9999, unsigned short, сетевой порядок).
    - 2 байта — значение `AA` (сетевой порядок).
    - 12 байт — номер телефона (текстовые символы).
    - `N+1` байт — текст сообщения `Message` с завершающим нулевым байтом.
  - Сервер отвечает на каждое сообщение двумя байтами: `o`, `k` (подтверждение `ok`).
  - Клиент может отправлять сообщения подряд, не дожидаясь `ok`, но должен получить подтверждение на последнее сообщение перед завершением.
- **Обработка файла**: Чтение строк выполняется через `getline`, строки парсятся в структуру `network_packet` и отправляются через `send_packet`.
- **Ограничения**:
  - Не создаёт дополнительных файлов в текущем каталоге.
  - Минимальный вывод в `stdout`, только важные сообщения и ошибки.
  - Не переподключается для каждого сообщения — использует одно соединение.


---

## Серверная программа (tcpserver.cpp)

### Описание

Программа `tcpserver` — сервер, реализованный на языке C++ для Windows с использованием механизма `WSAEvents`. Сервер принимает входящие TCP-соединения, обрабатывает сообщения от клиентов, логирует их в файл `msg.txt` и отправляет подтверждения `ok`. Сервер работает в неблокирующем режиме и поддерживает одновременное обслуживание нескольких клиентов.

### Запуск сервера

Сервер запускается с аргументом командной строки:

```
tcpserver 9000
```

- `tcpserver` — имя исполняемого файла.
- `9000` — номер TCP-порта для прослушивания.

### Особенности реализации сервера

- **Платформа**: Windows, компиляция с использованием Microsoft Visual Studio 2010.
- **Режим работы сокета**: Неблокирующий.
- **Механизм обработки**: Однопоточная программа с использованием `WSAEvents` для параллельного обслуживания клиентов.
- **Логирование**:
  - Сообщения сохраняются в файл `msg.txt` в формате: `IP:порт сообщение`.
  - Сообщения накапливаются в буфере `log_buffer` и записываются в файл при подтверждении активности клиента или при завершении работы.
- **Протокол взаимодействия**:
  - Сервер принимает сообщения в формате, описанном для клиента.
  - На каждое сообщение отправляется подтверждение `ok` (2 байта: `o`, `k`).
  - Если сообщение содержит текст `stop`, сервер отправляет `ok`, закрывает все соединения и завершает работу.
- **Обработка событий**:
  - События собираются от прослушивающего сокета и клиентов через `WSAWaitForMultipleEvents`.
  - Новые подключения (`FD_ACCEPT`) обрабатываются с созданием события для клиента.
  - Чтение данных (`FD_READ`) и закрытие соединений (`FD_CLOSE`) обрабатываются через `handle_client_read` и `process_client_buffer`.
- **Обработка ошибок**:
  - При невозможности открыть порт сервер выводит ошибку в `stdout` и завершается.
  - Ошибки чтения или записи данных приводят к удалению клиента без записи его буфера.
  - Минимальный вывод диагностики в `stdout`.


---

## Структура проекта

- `tcpclient.cpp` — исходный код клиентской программы.
- `tcpserver.cpp` — исходный код серверной программы.
- `msg.txt` — файл для логов сервера.
